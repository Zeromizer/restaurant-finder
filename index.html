<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Restaurant Matcher</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: Arial, sans-serif;
        }

        body {
            background-color: #f5f5f5;
            color: #333;
            line-height: 1.6;
        }

        .container {
            max-width: 500px;
            margin: 20px auto;
            padding: 20px;
            overflow: hidden;
        }

        /* Basic hiding class */
        .hidden {
            display: none !important; /* Use important to ensure it overrides other display properties if needed */
        }

        /* View transition styles */
        .view {
            width: 100%;
            opacity: 1;
            transition: opacity 0.3s ease-in-out;
            display: block; /* Views should be block by default */
        }
        .view.transition-hidden { /* Use a different class for transition hiding */
            opacity: 0;
            height: 0;
            overflow: hidden;
            pointer-events: none;
            /* display: block is inherited */
        }


        .header {
            text-align: center;
            margin-bottom: 20px;
        }

        .header h1 {
            color: #FF5864;
            margin-bottom: 5px;
        }

        .search-form {
            background-color: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #555;
        }

        input, select {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
            background-color: #fff;
        }
        input:focus, select:focus {
            border-color: #FF5864;
            outline: none;
            box-shadow: 0 0 0 2px rgba(255, 88, 100, 0.2);
        }

        .button {
            background-color: #FF5864;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 30px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            display: inline-block;
            text-align: center;
            width: 100%;
            transition: background-color 0.2s ease, transform 0.1s ease;
        }

        .button:hover:not(:disabled) { /* Apply hover only when not disabled */
            background-color: #e1404d;
            transform: scale(1.02);
        }
        .button:active:not(:disabled) { /* Apply active only when not disabled */
             transform: scale(0.98);
        }

        .button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        /* Card Layout */
        .card {
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.15);
            overflow: hidden;
            margin-bottom: 20px;
            height: 580px;
            position: relative;
            display: flex;
            flex-direction: column;
        }

        .photo-container {
            position: relative;
            width: 100%;
            height: 55%;
            overflow: hidden;
            flex-shrink: 0;
            background-color: #eee;
        }

        .card-img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
        }

        /* Photo Navigation */
         .photo-nav {
            position: absolute;
            left: 0;
            right: 0;
            bottom: 10px;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1;
        }

        .photo-nav-btn {
            background-color: rgba(0, 0, 0, 0.5);
            color: white;
            border: none;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            margin: 0 5px;
            transition: background-color 0.2s;
        }
        .photo-nav-btn:hover {
            background-color: rgba(0, 0, 0, 0.8);
        }


        #photo-indicators {
            display: flex;
            justify-content: center;
            margin: 0 10px;
        }
         .photo-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: rgba(255, 255, 255, 0.5);
            margin: 0 4px;
            display: inline-block;
            transition: background-color 0.3s;
        }
        .photo-dot.active {
            background-color: #fff;
        }


        /* Card Content Area */
         .card-content {
            padding: 15px;
            flex-grow: 1;
            overflow-y: auto;
             padding-bottom: 85px; /* Increased padding to ensure no overlap with actions */
        }

        .card-title {
            font-size: 22px;
            font-weight: 600;
            margin-bottom: 8px;
            color: #333;
        }

        .card-info {
            color: #555;
            margin-bottom: 8px;
            font-size: 15px;
        }
        .card-info#restaurant-address {
             line-height: 1.4;
        }

        /* Card Actions Area - Positioned Absolutely */
        .card-actions {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            display: flex;
            justify-content: space-around;
            padding: 15px 15px 20px 15px; /* Added more bottom padding */
            background: linear-gradient(to top, rgba(255,255,255,1) 60%, rgba(255,255,255,0));
            border-top: 1px solid #eee;
             z-index: 2;
        }

        .action-button {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: white;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            font-size: 24px;
        }
        .action-button:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }
         .action-button:active {
             transform: scale(1.05);
             box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15);
         }

        .like-button { color: #00d174; }
        .dislike-button { color: #fd5068; }
        .info-button { color: #2980b9; }

        .loading {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: 300px;
            padding: 20px;
            text-align: center;
            color: #555;
        }

        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border-left-color: #FF5864;
            animation: spin 1s linear infinite;
            margin-bottom: 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Error message styling */
        .error-message {
            color: #c0392b;
            text-align: center;
            padding: 15px;
            background-color: #fbecea;
            border: 1px solid #e74c3c;
            border-radius: 8px;
            margin: 20px 0; /* Keep margin for when it's visible */
            font-size: 15px;
        }
        /* #error-container starts hidden via the .hidden class */


        .restaurant-list {
            background-color: white;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            margin-top: 15px;
        }

        .restaurant-item {
            padding: 15px 10px;
            border-bottom: 1px solid #eee;
        }
        .restaurant-item:last-child {
            border-bottom: none;
        }
         .restaurant-item h3 {
             margin-bottom: 5px;
             color: #333;
         }
         .restaurant-item p {
             font-size: 14px;
             color: #666;
             margin-bottom: 3px;
         }

        .price-level {
            color: #27ae60;
            font-weight: 500;
        }

        .location-input-container {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .location-input {
            flex-grow: 1;
        }

        .location-button {
            width: auto;
            padding: 10px 15px;
            white-space: nowrap;
            flex-shrink: 0;
            font-size: 15px;
            height: 42px; /* Approx match input height */
            line-height: 1.4;
        }

        /* Google Places Autocomplete styles */
        .pac-container {
            font-family: Arial, sans-serif;
            border-radius: 4px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
            z-index: 1000 !important;
        }

        .pac-item {
            padding: 10px;
            cursor: pointer;
            font-size: 15px;
        }

        .pac-item:hover {
            background-color: #f5f5f5;
        }
        .pac-item-query {
            font-weight: 500;
        }

    </style>
</head>
<body>
    <div class="container">
         <!-- Error container starts hidden -->
         <div id="error-container" class="error-message hidden"></div>

        <!-- Search View -->
        <div id="search-view" class="view"> <!-- Add view class -->
            <div class="header">
                <h1>Restaurant Matcher</h1>
                <p>Find restaurants to enjoy with friends</p>
            </div>

            <form id="search-form" class="search-form">
                <div class="form-group">
                    <label for="location">Location</label>
                    <div class="location-input-container">
                        <input
                            id="location"
                            type="text"
                            placeholder="Enter city, neighborhood, or address"
                            class="location-input"
                            required
                        />
                        <button type="button" id="use-location-button" class="button location-button">
                            üìç My Location
                        </button>
                    </div>
                </div>

                <div class="form-group">
                    <label for="radius">Distance (km)</label>
                    <select id="radius">
                        <option value="1000">1 km</option>
                        <option value="2000" selected>2 km</option>
                        <option value="5000">5 km</option>
                        <option value="10000">10 km</option>
                        <option value="20000">20 km</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="price-level">Price Level</label>
                    <select id="price-level">
                        <option value="">Any</option>
                        <option value="1">$ (Inexpensive)</option>
                        <option value="2">$$ (Moderate)</option>
                        <option value="3">$$$ (Expensive)</option>
                        <option value="4">$$$$ (Very Expensive)</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="cuisine">Cuisine Type (Optional)</label>
                    <select id="cuisine">
                        <option value="">Any</option>
                        <option value="Italian">Italian</option>
                        <option value="Chinese">Chinese</option>
                        <option value="Japanese">Japanese</option>
                        <option value="Mexican">Mexican</option>
                        <option value="Indian">Indian</option>
                        <option value="Thai">Thai</option>
                        <option value="American">American</option>
                        <option value="French">French</option>
                        <option value="Vietnamese">Vietnamese</option>
                        <option value="Korean">Korean</option>
                        <option value="Mediterranean">Mediterranean</option>
                        <option value="Pizza">Pizza</option>
                        <option value="Sushi">Sushi</option>
                        <option value="Cafe">Cafe</option>
                        <option value="Bar">Bar</option>
                    </select>
                </div>

                <button type="submit" class="button" id="search-button">
                    Find Restaurants
                </button>
            </form>
        </div>

        <!-- Loading View -->
        <div id="loading-view" class="view transition-hidden"> <!-- Start hidden with transition class -->
             <div class="loading">
                <div class="spinner"></div>
                <p>Finding restaurants...</p>
            </div>
        </div>

        <!-- Swipe View -->
        <div id="swipe-view" class="view transition-hidden"> <!-- Start hidden with transition class -->
            <div class="header">
                <h1>Find Your Match</h1>
                <p>Restaurant <span id="current-index">1</span> of <span id="total-restaurants">20</span></p>
            </div>

            <div class="card">
                <div class="photo-container">
                    <img class="card-img" id="restaurant-image" src="https://placehold.co/600x400?text=Loading..." alt="Restaurant">
                    <div class="photo-nav">
                        <button id="prev-photo" class="photo-nav-btn">‚ùÆ</button>
                        <div id="photo-indicators"></div>
                        <button id="next-photo" class="photo-nav-btn">‚ùØ</button>
                    </div>
                </div>
                <div class="card-content">
                    <h2 class="card-title" id="restaurant-name">Loading...</h2>
                    <p class="card-info" id="restaurant-cuisine">Cuisine: ...</p>
                    <p class="card-info" id="restaurant-rating">Rating: ...</p>
                    <p class="card-info" id="restaurant-price">Price: ...</p>
                    <p class="card-info" id="restaurant-address">Address: ...</p>
                </div>
                 <div class="card-actions">
                    <div class="action-button dislike-button" id="dislike-button">‚ùå</div>
                    <div class="action-button info-button" id="info-button">‚ÑπÔ∏è</div>
                    <div class="action-button like-button" id="like-button">‚ù§Ô∏è</div>
                </div>
            </div>
        </div>

        <!-- Results View -->
        <div id="results-view" class="view transition-hidden"> <!-- Start hidden with transition class -->
            <div class="header">
                <h1>Your Results</h1>
                <p>You liked <span id="liked-count">0</span> restaurant(s)</p>
            </div>

            <div class="search-form">
                <p style="text-align: center; margin-bottom: 15px;">Share this code with your friend:</p>
                <p style="text-align: center; margin-bottom: 20px;">
                    <strong id="session-id" style="font-size: 1.5em; background-color: #eee; padding: 5px 10px; border-radius: 4px; user-select: all; cursor: pointer;"></strong>
                    <button id="copy-code-button" style="margin-left: 10px; background: none; border: none; font-size: 1.2em; cursor: pointer;">üìã</button>
                </p>


                <div class="form-group">
                    <label for="friend-code">Enter Friend's Code</label>
                    <input
                        id="friend-code"
                        type="text"
                        placeholder="Paste friend's code here"
                    />
                </div>

                <button class="button" id="find-matches-button">
                    Find Matches
                </button>

                <button class="button" id="start-over-button" style="margin-top: 15px; background-color: #6c757d; border-color: #6c757d;">
                    Start Over
                </button>
            </div>
        </div>

        <!-- Matches View -->
        <div id="matches-view" class="view transition-hidden"> <!-- Start hidden with transition class -->
            <div class="header">
                <h1>Your Matches!</h1>
                <p>Restaurants both you and your friend liked</p>
            </div>

            <div id="matches-list" class="restaurant-list">
                <p>Loading matches...</p>
            </div>

            <button class="button" id="matches-start-over-button" style="margin-top: 20px;">
                Start Over
            </button>
        </div>
    </div>

    <script>
        // DOM Elements
        const views = {
            search: document.getElementById('search-view'),
            loading: document.getElementById('loading-view'),
            swipe: document.getElementById('swipe-view'),
            results: document.getElementById('results-view'),
            matches: document.getElementById('matches-view')
        };

        const searchForm = document.getElementById('search-form');
        const locationInput = document.getElementById('location');
        const useLocationButton = document.getElementById('use-location-button');
        const radiusSelect = document.getElementById('radius');
        const priceLevelSelect = document.getElementById('price-level');
        const cuisineSelect = document.getElementById('cuisine');
        const searchButton = document.getElementById('search-button');

        const swipeUI = {
            currentIndex: document.getElementById('current-index'),
            totalRestaurants: document.getElementById('total-restaurants'),
            image: document.getElementById('restaurant-image'),
            name: document.getElementById('restaurant-name'),
            cuisine: document.getElementById('restaurant-cuisine'),
            rating: document.getElementById('restaurant-rating'),
            price: document.getElementById('restaurant-price'),
            address: document.getElementById('restaurant-address'),
            prevPhotoBtn: document.getElementById('prev-photo'),
            nextPhotoBtn: document.getElementById('next-photo'),
            photoIndicators: document.getElementById('photo-indicators'),
            dislikeButton: document.getElementById('dislike-button'),
            infoButton: document.getElementById('info-button'),
            likeButton: document.getElementById('like-button')
        };

        const resultsUI = {
             likedCount: document.getElementById('liked-count'),
             sessionId: document.getElementById('session-id'),
             friendCodeInput: document.getElementById('friend-code'),
             findMatchesButton: document.getElementById('find-matches-button'),
             startOverButton: document.getElementById('start-over-button'),
             copyCodeButton: document.getElementById('copy-code-button')
        };

         const matchesUI = {
            list: document.getElementById('matches-list'),
            startOverButton: document.getElementById('matches-start-over-button')
         };

        const errorContainer = document.getElementById('error-container');

        // App State
        let restaurants = [];
        let currentIndex = 0;
        let likedRestaurants = {};
        let sessionId = '';
        let userCoordinates = null;
        let autocomplete = null;
        let currentVisibleView = views.search; // Track the current visible view

        // --- Core Functions ---

        // Show a specific view with transition
        function showView(viewToShow) {
             // Hide all views using the transition class first
             Object.values(views).forEach(view => {
                 if (view !== viewToShow) {
                    view.classList.add('transition-hidden');
                 }
             });

              // Make the target view visible
             viewToShow.classList.remove('transition-hidden'); // Make it visible for transition
             currentVisibleView = viewToShow;
             window.scrollTo(0, 0); // Scroll to top on view change
        }


        // Show error message
        function showError(message) {
            errorContainer.textContent = message;
            errorContainer.classList.remove('hidden'); // Use the standard hidden class
        }

        // Hide error message
        function hideError() {
            errorContainer.classList.add('hidden'); // Use the standard hidden class
            errorContainer.textContent = '';
        }

         // --- Google Maps / Geolocation ---

         function loadGoogleMapsScript() {
             if (document.getElementById('google-maps-script')) return;

             const script = document.createElement('script');
             script.id = 'google-maps-script';
             const apiKey = "AIzaSyCHBWV_-CcYHftllY2aZ22SfSySw9PjqFo"; // Replace with your key
             if (!apiKey || apiKey.startsWith("AIzaSy")) { // Basic check for placeholder/real key
                 console.warn("Google Maps API Key might be missing or invalid.");
                 // Decide if app should proceed without maps or show error
                 // showError("Map services require configuration.");
                 // return; // Optional: stop if key is invalid
             }
             script.src = `https://maps.googleapis.com/maps/api/js?key=${apiKey}&libraries=places,geometry&callback=initMapServices`;
             script.async = true;
             script.defer = true;
             script.onerror = () => {
                 console.error("Failed to load Google Maps script.");
                 showError("Failed to load location services. Check connection/refresh.");
             };
             document.head.appendChild(script);
        }

        window.initMapServices = function() {
             console.log("Google Maps API loaded and ready.");
             initAutocomplete();
        };

        function initAutocomplete() {
            console.log("Initializing Places Autocomplete");
            if (typeof google === 'undefined' || !google.maps || !google.maps.places) {
                console.error("Google Maps Places library not loaded for Autocomplete.");
                return;
            }

            autocomplete = new google.maps.places.Autocomplete(
                locationInput,
                {
                    types: ['geocode', 'establishment'],
                    fields: ['geometry', 'name', 'formatted_address', 'place_id'],
                    componentRestrictions: { country: [] }
                }
            );

            autocomplete.addListener('place_changed', function() {
                const place = autocomplete.getPlace();
                hideError();

                if (!place.geometry || !place.geometry.location) {
                    console.log("Autocomplete selection has no geometry:", place.name);
                    userCoordinates = null;
                    return;
                }

                userCoordinates = {
                    lat: place.geometry.location.lat(),
                    lng: place.geometry.location.lng()
                };
                console.log("Place selected:", place.name, "Coords:", userCoordinates);
                locationInput.value = place.formatted_address || place.name;
            });
        }

        function getUserLocation() {
            if (!navigator.geolocation) {
                showError("Geolocation is not supported.");
                return;
            }

            useLocationButton.textContent = "Finding...";
            useLocationButton.disabled = true;
            hideError();

            navigator.geolocation.getCurrentPosition(
                (position) => {
                    userCoordinates = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude
                    };
                    console.log("Geolocation successful:", userCoordinates);
                    locationInput.value = `Current Location (${userCoordinates.lat.toFixed(4)}, ${userCoordinates.lng.toFixed(4)})`;
                    useLocationButton.textContent = "üìç My Location";
                    useLocationButton.disabled = false;
                },
                (error) => {
                    console.error("Geolocation error:", error);
                    let message = "Could not get your location.";
                    switch(error.code) {
                        case error.PERMISSION_DENIED: message = "Location permission denied."; break;
                        case error.POSITION_UNAVAILABLE: message = "Location info unavailable."; break;
                        case error.TIMEOUT: message = "Location request timed out."; break;
                    }
                    showError(message);
                    userCoordinates = null;
                    locationInput.value = '';
                    useLocationButton.textContent = "üìç My Location";
                    useLocationButton.disabled = false;
                },
                { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
            );
        }

        // --- Restaurant Search & Display ---

        function fetchRestaurants() {
            showView(views.loading);
            hideError();

            const locationText = locationInput.value;
            const radius = parseInt(radiusSelect.value);
            const priceLevel = priceLevelSelect.value;
            const cuisine = cuisineSelect.value;

            if (typeof google === 'undefined' || !google.maps || !google.maps.places) {
                showError("Location services not ready. Wait/refresh.");
                showView(views.search);
                return;
            }

            if (userCoordinates) {
                performNearbySearch(userCoordinates, radius, cuisine, priceLevel);
            } else if (locationText && !locationText.startsWith("Current Location")) {
                const geocoder = new google.maps.Geocoder();
                geocoder.geocode({ address: locationText }, (results, status) => {
                    if (status === 'OK' && results?.[0]?.geometry?.location) {
                         userCoordinates = { lat: results[0].geometry.location.lat(), lng: results[0].geometry.location.lng() };
                         console.log("Geocoded:", locationText, "to:", userCoordinates);
                         performNearbySearch(userCoordinates, radius, cuisine, priceLevel);
                    } else {
                         console.error("Geocoding failed:", status);
                         showError(`Could not find coordinates for "${locationText}".`);
                         showView(views.search);
                    }
                });
            } else {
                 showError("Please provide a location.");
                 showView(views.search);
            }
        }

        function performNearbySearch(coords, radius, cuisine, priceLevel) {
            const placesService = new google.maps.places.PlacesService(document.createElement('div'));

            let request = {
                location: new google.maps.LatLng(coords.lat, coords.lng),
                radius: radius,
                type: 'restaurant',
            };

            if (cuisine) request.keyword = cuisine;
            if (priceLevel) {
                request.minPriceLevel = parseInt(priceLevel);
                request.maxPriceLevel = parseInt(priceLevel);
            }

            console.log("Places API Request:", request);

            placesService.nearbySearch(request, (results, status) => {
                console.log("Places API Response Status:", status);
                 if (status === google.maps.places.PlacesServiceStatus.OK && results?.length > 0) {
                     const operationalResults = results
                         .filter(place => place.business_status === 'OPERATIONAL')
                         .slice(0, 20);

                    if (operationalResults.length === 0) {
                         showError(`No operational restaurants found matching criteria.`);
                         showView(views.search);
                         return;
                    }
                    console.log("Found", operationalResults.length, "operational restaurants. Fetching details...");
                    processRestaurantResults(operationalResults, cuisine);

                 } else if (status === google.maps.places.PlacesServiceStatus.ZERO_RESULTS) {
                     showError("No restaurants found matching criteria.");
                     showView(views.search);
                 } else {
                     console.error("Places API Error:", status);
                     showError(`Could not fetch restaurants (Error: ${status}).`);
                     showView(views.search);
                 }
            });
        }

        function getPlaceDetails(placeIds) {
            const placesService = new google.maps.places.PlacesService(document.createElement('div'));
            const promises = placeIds.map(placeId => {
                return new Promise((resolve) => { // No reject, always resolve
                    placesService.getDetails({ placeId, fields: ['photos', 'name'] },
                        (details, status) => {
                            resolve({ placeId, photos: (status === google.maps.places.PlacesServiceStatus.OK && details?.photos) ? details.photos : [] });
                        }
                    );
                });
            });
            return Promise.all(promises);
        }

        async function processRestaurantResults(results, searchCuisine) {
            try {
                const placeIds = results.map(r => r.place_id);
                const details = await getPlaceDetails(placeIds);
                const detailsMap = details.reduce((map, detail) => {
                    map[detail.placeId] = detail.photos;
                    return map;
                }, {});

                restaurants = results.map(place => {
                    const placePhotos = detailsMap[place.place_id] || place.photos || [];
                    const photoUrls = placePhotos
                         .slice(0, 5)
                         .map(photo => photo.getUrl ? photo.getUrl({ maxWidth: 600 }) : null)
                         .filter(url => url);

                    if (photoUrls.length === 0) {
                        photoUrls.push("https://placehold.co/600x400/FF5864/white?text=No+Image");
                    }

                    return {
                        id: place.place_id,
                        name: place.name || "Unnamed Restaurant",
                        address: place.vicinity || "Address unavailable",
                        cuisine: searchCuisine || getCuisineFromTypes(place.types || []),
                        rating: place.rating ? `${place.rating}‚òÖ (${place.user_ratings_total || 0})` : "Not rated",
                        priceLevel: place.price_level === undefined ? 0 : place.price_level,
                        photoUrls: photoUrls,
                        currentPhotoIndex: 0
                    };
                });

                if (restaurants.length === 0) {
                     showError('No restaurants found after processing.');
                     showView(views.search);
                     return;
                }

                sessionId = generateSessionId();
                saveSessionToFirebase();

                currentIndex = 0;
                likedRestaurants = {};
                updateRestaurantDisplay(); // Initial display of first card
                showView(views.swipe);

            } catch (error) {
                console.error("Error processing restaurant results:", error);
                showError("Error loading restaurant details.");
                showView(views.search);
            }
        }

        function getCuisineFromTypes(types) {
            const typeMap = { 'cafe': 'Cafe', 'bar': 'Bar', 'bakery': 'Bakery' };
            const knownCuisines = ["Italian", "Chinese", "Japanese", "Mexican", "Indian", "Thai", "American", "French", "Vietnamese", "Korean", "Mediterranean", "Pizza", "Sushi", "Seafood", "Steakhouse"];
            for (const type of types) {
                const formattedType = type.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                if (knownCuisines.includes(formattedType)) return formattedType;
                if (typeMap[type]) return typeMap[type];
            }
            return types.includes('restaurant') ? 'Restaurant' : 'Food';
        }

        function updateRestaurantDisplay() {
            if (currentIndex >= restaurants.length) {
                showResultsView(); // Should be handled by swipe logic, but safe fallback
                return;
            }
            const restaurant = restaurants[currentIndex];

            swipeUI.currentIndex.textContent = currentIndex + 1;
            swipeUI.totalRestaurants.textContent = restaurants.length;
            restaurant.currentPhotoIndex = restaurant.currentPhotoIndex || 0; // Ensure index exists
            swipeUI.image.src = restaurant.photoUrls[restaurant.currentPhotoIndex];
            swipeUI.image.alt = restaurant.name;

            swipeUI.photoIndicators.innerHTML = '';
            restaurant.photoUrls.forEach((_, index) => {
                const dot = document.createElement('span');
                dot.className = 'photo-dot' + (index === restaurant.currentPhotoIndex ? ' active' : '');
                swipeUI.photoIndicators.appendChild(dot);
            });

            const showNav = restaurant.photoUrls.length > 1;
            swipeUI.prevPhotoBtn.style.display = showNav ? 'flex' : 'none';
            swipeUI.nextPhotoBtn.style.display = showNav ? 'flex' : 'none';
            swipeUI.photoIndicators.style.display = showNav ? 'flex' : 'none';

            swipeUI.name.textContent = restaurant.name;
            swipeUI.cuisine.textContent = `Cuisine: ${restaurant.cuisine}`;
            swipeUI.rating.textContent = `Rating: ${restaurant.rating}`;
            swipeUI.price.textContent = `Price: ${restaurant.priceLevel > 0 ? '$'.repeat(restaurant.priceLevel) : 'N/A'}`;
            swipeUI.address.textContent = `Address: ${restaurant.address}`;

            views.swipe.querySelector('.card-content').scrollTop = 0;
        }

        function changePhoto(direction) {
             if (currentIndex >= restaurants.length) return;
             const restaurant = restaurants[currentIndex];
             const numPhotos = restaurant.photoUrls.length;
             if (numPhotos <= 1) return;
             restaurant.currentPhotoIndex = (restaurant.currentPhotoIndex + direction + numPhotos) % numPhotos;
             updateRestaurantDisplay();
        }

        // --- Swiping and Matching Logic ---

        function handleSwipe(liked) {
             if (currentIndex >= restaurants.length) return;

            const restaurantId = restaurants[currentIndex].id;
            if (liked) {
                likedRestaurants[restaurantId] = true;
            }
             saveLikesToFirebase(); // Update DB async

            currentIndex++;
            if (currentIndex < restaurants.length) {
                updateRestaurantDisplay();
            } else {
                showResultsView();
            }
        }

        function showResultsView() {
             const likedCount = Object.keys(likedRestaurants).length;
             resultsUI.likedCount.textContent = likedCount;
             resultsUI.sessionId.textContent = sessionId;
             resultsUI.friendCodeInput.value = '';
             showView(views.results);
        }

        function findMatches() {
            const friendCode = resultsUI.friendCodeInput.value.trim();
            if (!friendCode) { showError('Please enter friend\'s code.'); return; }
            if (friendCode === sessionId) { showError('Enter your friend\'s code, not yours.'); return; }

            showView(views.loading);
            hideError();

            if (typeof firebase === 'undefined' || !firebase.apps.length) {
                 console.warn("Firebase not ready, simulating match.");
                 setTimeout(() => { /* ... (Simulation logic) ... */ displayMatches([]); }, 1500);
                 return;
             }

            firebase.database().ref('sessions/' + friendCode).once('value')
                .then(snapshot => {
                    const friendData = snapshot.val();
                    if (!friendData?.likes) {
                        showError('Friend\'s code not found or invalid.');
                        showView(views.results); return;
                    }
                    const friendLikes = friendData.likes || {};
                    const friendLikedIds = Object.keys(friendLikes);
                    const myLikedIds = Object.keys(likedRestaurants);
                    const matchedIds = myLikedIds.filter(id => friendLikedIds.includes(id));

                    const friendRestaurantsData = friendData.restaurants || [];
                    const friendRestaurantsMap = friendRestaurantsData.reduce((map, r) => { map[r.id] = r; return map; }, {});
                    const myRestaurantsMap = restaurants.reduce((map, r) => { map[r.id] = r; return map; }, {});
                    const matchedRestaurants = matchedIds.map(id => friendRestaurantsMap[id] || myRestaurantsMap[id]).filter(r => r);

                    displayMatches(matchedRestaurants);
                })
                .catch(error => {
                    console.error("Error fetching friend's data:", error);
                    showError('Could not retrieve friend\'s data.');
                    showView(views.results);
                });
        }

        function displayMatches(matchedRestaurants) {
            matchesUI.list.innerHTML = '';
            if (matchedRestaurants.length > 0) {
                matchedRestaurants.forEach(r => {
                    const item = document.createElement('div');
                    item.className = 'restaurant-item';
                    const price = r.priceLevel > 0 ? '$'.repeat(r.priceLevel) : 'N/A';
                    item.innerHTML = `<h3>${r.name}</h3><p>Cuisine: ${r.cuisine}</p><p>Rating: ${r.rating}</p><p class="price-level">Price: ${price}</p><p>Address: ${r.address}</p>`;
                    matchesUI.list.appendChild(item);
                });
            } else {
                matchesUI.list.innerHTML = '<p style="text-align: center; padding: 20px;">No common matches found!</p>';
            }
            showView(views.matches);
        }

         // --- Firebase & Session ---

         function generateSessionId() {
             return Math.random().toString(36).substring(2, 10).toUpperCase();
         }

         function saveSessionToFirebase() {
             if (typeof firebase === 'undefined' || !firebase.apps.length || !sessionId) return;
             const restaurantsToSave = restaurants.map(r => ({
                 id: r.id, name: r.name, address: r.address, cuisine: r.cuisine,
                 rating: r.rating, priceLevel: r.priceLevel
             }));
             firebase.database().ref('sessions/' + sessionId).set({
                 restaurants: restaurantsToSave,
                 timestamp: firebase.database.ServerValue.TIMESTAMP,
                 likes: {}
             }).catch(error => console.error("Firebase session save error:", error));
         }

         function saveLikesToFirebase() {
             if (typeof firebase === 'undefined' || !firebase.apps.length || !sessionId) return;
             firebase.database().ref('sessions/' + sessionId + '/likes').set(likedRestaurants)
                 .catch(error => console.error("Firebase likes update error:", error));
         }

         function initializeFirebase() {
              if (typeof firebase === 'undefined' || typeof firebase.initializeApp === 'undefined') {
                  console.warn("Firebase SDK not ready for init.");
                  return;
              }
             try {
                 const firebaseConfig = { /* ... Your Config ... */
                    apiKey: "AIzaSyDauSN6vYVefIYHYdx54hIsXWeTxp-CgrM",
                    authDomain: "restaurant-finder-36e61.firebaseapp.com",
                    databaseURL: "https://restaurant-finder-36e61-default-rtdb.asia-southeast1.firebasedatabase.app",
                    projectId: "restaurant-finder-36e61",
                    storageBucket: "restaurant-finder-36e61.appspot.com",
                    messagingSenderId: "266887715200",
                    appId: "1:266887715200:web:6c68d924d7596cdfb44965",
                    measurementId: "G-TD5GNXZZMN"
                 };
                 if (!firebase.apps.length) {
                      firebase.initializeApp(firebaseConfig);
                      console.log("Firebase initialized.");
                 }
             } catch (e) {
                 console.error("Error initializing Firebase:", e);
                 showError("Sharing service unavailable.");
             }
         }

        // --- Utility & Reset ---

        function resetApp() {
            // Clear inputs
            locationInput.value = '';
            radiusSelect.value = '2000';
            priceLevelSelect.value = '';
            cuisineSelect.value = '';
            resultsUI.friendCodeInput.value = '';
            // Reset state
            restaurants = [];
            currentIndex = 0;
            likedRestaurants = {};
            sessionId = '';
            userCoordinates = null;
            hideError();
            showView(views.search); // Go back to start
        }

        function copySessionId() {
            const code = resultsUI.sessionId.textContent;
            if (!code || !navigator.clipboard) { showError("Copy failed."); return; }
            navigator.clipboard.writeText(code).then(() => {
                const originalText = resultsUI.copyCodeButton.textContent;
                resultsUI.copyCodeButton.textContent = '‚úÖ';
                setTimeout(() => { resultsUI.copyCodeButton.textContent = originalText; }, 1500);
            }).catch(err => { console.error('Copy failed: ', err); showError("Copy failed."); });
        }

        // --- Event Listeners ---
        searchForm.addEventListener('submit', (e) => { e.preventDefault(); fetchRestaurants(); });
        useLocationButton.addEventListener('click', getUserLocation);
        swipeUI.prevPhotoBtn.addEventListener('click', () => changePhoto(-1));
        swipeUI.nextPhotoBtn.addEventListener('click', () => changePhoto(1));
        swipeUI.dislikeButton.addEventListener('click', () => handleSwipe(false));
        swipeUI.likeButton.addEventListener('click', () => handleSwipe(true));
        swipeUI.infoButton.addEventListener('click', () => { /* ... (Alert logic) ... */ });
        resultsUI.findMatchesButton.addEventListener('click', findMatches);
        resultsUI.startOverButton.addEventListener('click', resetApp);
        resultsUI.copyCodeButton.addEventListener('click', copySessionId);
        resultsUI.sessionId.addEventListener('click', () => { window.getSelection().selectAllChildren(resultsUI.sessionId); });
        matchesUI.startOverButton.addEventListener('click', resetApp);

        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            console.log("DOM fully loaded.");
            showView(views.search); // Start on search view
            loadGoogleMapsScript();
            initializeFirebase(); // Attempt initialization
        });

    </script>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js" defer></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js" defer></script>

</body>
</html>
