<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Restaurant Matcher</title>
    <style>
        /* --- Base Styles --- */
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: Arial, sans-serif; }
        body { background-color: #f5f5f5; color: #333; line-height: 1.6; }
        .container { max-width: 500px; margin: 20px auto; padding: 20px; overflow: hidden; }
        .hidden { display: none !important; }

        /* --- View Transitions --- */
        .view { width: 100%; opacity: 1; transition: opacity 0.3s ease-in-out; display: block; }
        .view.transition-hidden { opacity: 0; height: 0; overflow: hidden; pointer-events: none; }

        /* --- Header --- */
        .header { text-align: center; margin-bottom: 20px; }
        .header h1 { color: #FF5864; margin-bottom: 5px; }

        /* --- Forms & Inputs --- */
        .search-form { background-color: white; border-radius: 8px; padding: 20px; box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1); margin-bottom: 20px; }
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 8px; font-weight: 500; color: #555; }
        input, select {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
            background-color: #fff;
            line-height: normal;
            height: 44px; /* Maintain consistent height for inputs/selects */
        }
        input:focus, select:focus { border-color: #FF5864; outline: none; box-shadow: 0 0 0 2px rgba(255, 88, 100, 0.2); }


        /* --- Buttons --- */
        .button {
            background-color: #FF5864; color: white; border: none;
            padding: 12px 20px; /* Consistent padding */
            border-radius: 30px; cursor: pointer; font-size: 16px; font-weight: 600;
            display: inline-block; /* Allows width: 100% to work */
            text-align: center; vertical-align: middle; /* Helps with vertical alignment */
            width: 100%;
            transition: background-color 0.2s ease, transform 0.1s ease;
            /* height: auto; Let padding define height */
            line-height: 1.5; /* Adjust line-height for better vertical centering with padding */
        }
        .button:hover:not(:disabled) { background-color: #e1404d; transform: scale(1.02); }
        .button:active:not(:disabled) { transform: scale(0.98); }
        .button:disabled { background-color: #ccc; cursor: not-allowed; transform: none; }

        /* --- Location Button Specific --- */
        .location-button {
            width: 100%;
            margin-top: 10px;
            /* REMOVED fixed height */
            /* REMOVED white-space: nowrap; */
            /* REMOVED specific line-height (inherited from .button) */
            /* Ensure padding from .button is sufficient */
        }

        /* --- Card Layout (Unchanged) --- */
        .card { background-color: white; border-radius: 10px; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.15); overflow: hidden; margin-bottom: 20px; height: 580px; position: relative; display: flex; flex-direction: column; }
        .photo-container { position: relative; width: 100%; height: 55%; overflow: hidden; flex-shrink: 0; background-color: #eee; }
        .card-img { width: 100%; height: 100%; object-fit: cover; display: block; }
        .photo-nav { position: absolute; left: 0; right: 0; bottom: 10px; display: flex; justify-content: center; align-items: center; z-index: 1; }
        .photo-nav-btn { background-color: rgba(0, 0, 0, 0.5); color: white; border: none; width: 30px; height: 30px; border-radius: 50%; cursor: pointer; display: flex; justify-content: center; align-items: center; margin: 0 5px; transition: background-color 0.2s; }
        .photo-nav-btn:hover { background-color: rgba(0, 0, 0, 0.8); }
        #photo-indicators { display: flex; justify-content: center; margin: 0 10px; }
        .photo-dot { width: 8px; height: 8px; border-radius: 50%; background-color: rgba(255, 255, 255, 0.5); margin: 0 4px; display: inline-block; transition: background-color 0.3s; }
        .photo-dot.active { background-color: #fff; }
        .card-content { padding: 15px; flex-grow: 1; overflow-y: auto; padding-bottom: 85px; }
        .card-title { font-size: 22px; font-weight: 600; margin-bottom: 8px; color: #333; }
        .card-info { color: #555; margin-bottom: 8px; font-size: 15px; }
        .card-info#restaurant-address { line-height: 1.4; }
        .google-maps-link { display: inline-block; margin-top: 10px; padding: 6px 12px; background-color: #4285F4; color: white; text-decoration: none; border-radius: 4px; font-size: 14px; font-weight: 500; transition: background-color 0.2s; }
        .google-maps-link:hover { background-color: #357ae8; }
        .card-actions { position: absolute; bottom: 0; left: 0; right: 0; display: flex; justify-content: space-evenly; padding: 15px 15px 20px 15px; background: linear-gradient(to top, rgba(255,255,255,1) 60%, rgba(255,255,255,0)); border-top: 1px solid #eee; z-index: 2; }
        .action-button { width: 60px; height: 60px; border-radius: 50%; display: flex; justify-content: center; align-items: center; background-color: white; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15); cursor: pointer; transition: transform 0.2s ease, box-shadow 0.2s ease; font-size: 24px; }
        .action-button:hover { transform: scale(1.1); box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2); }
        .action-button:active { transform: scale(1.05); box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15); }
        .like-button { color: #00d174; }
        .dislike-button { color: #fd5068; }

        /* --- Loading & Error (Unchanged) --- */
        .loading { display: flex; flex-direction: column; justify-content: center; align-items: center; min-height: 300px; padding: 20px; text-align: center; color: #555; }
        .spinner { border: 4px solid rgba(0, 0, 0, 0.1); width: 36px; height: 36px; border-radius: 50%; border-left-color: #FF5864; animation: spin 1s linear infinite; margin-bottom: 15px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .error-message { color: #c0392b; text-align: center; padding: 15px; background-color: #fbecea; border: 1px solid #e74c3c; border-radius: 8px; margin: 20px 0; font-size: 15px; }

        /* --- Results & Matches (Unchanged) --- */
        .restaurant-list { background-color: white; border-radius: 8px; padding: 15px; box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1); margin-top: 15px; }
        .restaurant-item { padding: 15px 10px; border-bottom: 1px solid #eee; }
        .restaurant-item:last-child { border-bottom: none; }
        .restaurant-item h3 { margin-bottom: 5px; color: #333; }
        .restaurant-item p { font-size: 14px; color: #666; margin-bottom: 3px; }
        .price-level { color: #27ae60; font-weight: 500; }
        .restaurant-item .google-maps-link { font-size: 13px; padding: 4px 8px; margin-top: 8px; }

        /* --- Google Places Autocomplete (Unchanged) --- */
        .pac-container { font-family: Arial, sans-serif; border-radius: 4px; box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2); z-index: 1000 !important; }
        .pac-item { padding: 10px; cursor: pointer; font-size: 15px; }
        .pac-item:hover { background-color: #f5f5f5; }
        .pac-item-query { font-weight: 500; }

    </style>
</head>
<body>
    <div class="container">
         <div id="error-container" class="error-message hidden"></div>

        <!-- Search View -->
        <div id="search-view" class="view">
            <div class="header"> <h1>Restaurant Matcher</h1> <p>Find restaurants to enjoy with friends</p> </div>
            <form id="search-form" class="search-form">
                 <div class="form-group">
                    <label for="location">Location</label>
                    <input id="location" type="text" placeholder="Enter city, neighborhood, or address" class="location-input" required />
                    <button type="button" id="use-location-button" class="button location-button">üìç My Location</button>
                </div>
                 <div class="form-group"> <label for="radius">Distance (km)</label> <select id="radius" name="radius"> <option value="1000">1 km</option> <option value="2000" selected>2 km</option> <option value="5000">5 km</option> <option value="10000">10 km</option> <option value="20000">20 km</option> </select> </div>
                 <div class="form-group"> <label for="price-level">Price Level</label> <select id="price-level" name="price-level"> <option value="">Any</option> <option value="1">$ (Inexpensive)</option> <option value="2">$$ (Moderate)</option> <option value="3">$$$ (Expensive)</option> <option value="4">$$$$ (Very Expensive)</option> </select> </div>
                 <div class="form-group">
                    <label for="cuisine-keyword">Cuisine or Specific Dish (Optional)</label>
                    <input type="text" id="cuisine-keyword" name="cuisine-keyword" placeholder="e.g., Italian, Pizza, Laksa, Cafe">
                 </div>
                <button type="submit" class="button" id="search-button">Find Restaurants</button>
            </form>
        </div>

        <!-- Other Views (Loading, Swipe, Results, Matches) remain the same -->
        <div id="loading-view" class="view transition-hidden"> <div class="loading"><div class="spinner"></div><p>Finding restaurants...</p></div> </div>
        <div id="swipe-view" class="view transition-hidden"> <div class="header"> <h1>Find Your Match</h1> <p>Restaurant <span id="current-index">1</span> of <span id="total-restaurants">?</span></p> </div> <div class="card"> <div class="photo-container"> <img class="card-img" id="restaurant-image" src="..." alt="Restaurant"> <div class="photo-nav"> <button id="prev-photo" class="photo-nav-btn">‚ùÆ</button> <div id="photo-indicators"></div> <button id="next-photo" class="photo-nav-btn">‚ùØ</button> </div> </div> <div class="card-content"> <h2 class="card-title" id="restaurant-name">...</h2> <p class="card-info" id="restaurant-cuisine">...</p> <p class="card-info" id="restaurant-rating">...</p> <p class="card-info" id="restaurant-price">...</p> <p class="card-info" id="restaurant-address">...</p> <div id="google-maps-link-placeholder"></div> </div> <div class="card-actions"> <div class="action-button dislike-button" id="dislike-button">‚ùå</div> <div class="action-button like-button" id="like-button">‚ù§Ô∏è</div> </div> </div> </div>
        <div id="results-view" class="view transition-hidden"> <div class="header"> <h1>Your Results</h1> <p>You liked <span id="liked-count">0</span> restaurant(s)</p> </div> <div class="search-form"> <p style="text-align:center; margin-bottom:15px;">Share this code:</p> <p style="text-align:center; margin-bottom:20px;"> <strong id="session-id" style="font-size:1.5em; background-color:#eee; padding:5px 10px; border-radius:4px; user-select:all; cursor:pointer;">CODE</strong> <button id="copy-code-button" title="Copy Code" style="margin-left:10px; background:none; border:none; font-size:1.2em; cursor:pointer;">üìã</button> </p> <div class="form-group"> <label for="friend-code">Enter Friend's Code</label> <input id="friend-code" type="text" placeholder="Paste friend's code"/> </div> <button class="button" id="find-matches-button">Find Matches</button> <button class="button" id="start-over-button" style="margin-top:15px; background-color:#6c757d; border-color:#6c757d;">Start Over</button> </div> </div>
        <div id="matches-view" class="view transition-hidden"> <div class="header"> <h1>Your Matches!</h1> <p>Restaurants you both liked</p> </div> <div id="matches-list" class="restaurant-list"> <p>Loading matches...</p> </div> <button class="button" id="matches-start-over-button" style="margin-top:20px;">Start Over</button> </div>
    </div>

    <script>
        // --- JS Code ---
        const views = { search: document.getElementById('search-view'), loading: document.getElementById('loading-view'), swipe: document.getElementById('swipe-view'), results: document.getElementById('results-view'), matches: document.getElementById('matches-view') };
        const searchForm = document.getElementById('search-form');
        const locationInput = document.getElementById('location');
        const useLocationButton = document.getElementById('use-location-button');
        const radiusSelect = document.getElementById('radius');
        const priceLevelSelect = document.getElementById('price-level');
        const cuisineKeywordInput = document.getElementById('cuisine-keyword');
        const searchButton = document.getElementById('search-button');
        const swipeUI = { currentIndex: document.getElementById('current-index'), totalRestaurants: document.getElementById('total-restaurants'), image: document.getElementById('restaurant-image'), name: document.getElementById('restaurant-name'), cuisine: document.getElementById('restaurant-cuisine'), rating: document.getElementById('restaurant-rating'), price: document.getElementById('restaurant-price'), address: document.getElementById('restaurant-address'), prevPhotoBtn: document.getElementById('prev-photo'), nextPhotoBtn: document.getElementById('next-photo'), photoIndicators: document.getElementById('photo-indicators'), dislikeButton: document.getElementById('dislike-button'), likeButton: document.getElementById('like-button'), mapsLinkPlaceholder: document.getElementById('google-maps-link-placeholder') };
        const resultsUI = { likedCount: document.getElementById('liked-count'), sessionId: document.getElementById('session-id'), friendCodeInput: document.getElementById('friend-code'), findMatchesButton: document.getElementById('find-matches-button'), startOverButton: document.getElementById('start-over-button'), copyCodeButton: document.getElementById('copy-code-button') };
        const matchesUI = { list: document.getElementById('matches-list'), startOverButton: document.getElementById('matches-start-over-button') };
        const errorContainer = document.getElementById('error-container');

        let restaurants = [];
        let currentIndex = 0;
        let likedRestaurants = {};
        let sessionId = '';
        let userCoordinates = null;
        let autocomplete = null;
        let currentVisibleView = views.search;

        // --- Helper Functions (showView, showError, hideError) ---
        function showView(viewToShow) { Object.values(views).forEach(view => { if (view !== viewToShow) view.classList.add('transition-hidden'); }); viewToShow.classList.remove('transition-hidden'); currentVisibleView = viewToShow; window.scrollTo(0, 0); }
        function showError(message) { errorContainer.textContent = message; errorContainer.classList.remove('hidden'); }
        function hideError() { errorContainer.classList.add('hidden'); errorContainer.textContent = ''; }

        // --- Google Maps & Places API Functions ---
        function loadGoogleMapsScript() {
            if (document.getElementById('google-maps-script')) return;
            const script = document.createElement('script');
            script.id = 'google-maps-script';

            // *** UPDATED: Inserted your Google Maps API Key ***
            const apiKey = "AIzaSyCHBWV_-CcYHftllY2aZ22SfSySw9PjqFo";

            if (!apiKey || apiKey === "YOUR_GOOGLE_MAPS_API_KEY" || apiKey.length < 20) { // Keep check just in case
                console.error("Google Maps API Key missing/invalid!");
                showError("Map services are not configured correctly. Please contact the administrator.");
                locationInput.disabled = true;
                useLocationButton.disabled = true;
                searchButton.disabled = true;
                return;
            }
            script.src = `https://maps.googleapis.com/maps/api/js?key=${apiKey}&libraries=places,geometry&callback=initMapServices`;
            script.async = true;
            script.defer = true;
            script.onerror = () => {
                console.error("Failed to load Google Maps script.");
                showError("Failed to load location services. Check your internet connection and API key.");
            };
            document.head.appendChild(script);
        }

        window.initMapServices = function() {
             console.log("Google Maps API loaded.");
             initAutocomplete(); // Initialize autocomplete after the script is loaded
        };

        function initAutocomplete() {
            console.log("Initializing Autocomplete");
            if (typeof google === 'undefined' || !google.maps?.places?.Autocomplete) {
                console.error("Autocomplete library not ready.");
                showError("Location search feature failed to load.");
                return;
            }
            try {
                autocomplete = new google.maps.places.Autocomplete(locationInput, {
                    types: ['geocode', 'establishment'], // Search for addresses and places
                    fields: ['geometry', 'name', 'formatted_address', 'place_id'], // Data to return
                    componentRestrictions: { country: [] } // Allow global search initially
                });

                autocomplete.addListener('place_changed', () => {
                    const place = autocomplete.getPlace();
                    hideError(); // Hide previous errors
                    if (!place.geometry?.location) {
                        console.warn("Autocomplete: No geometry for place:", place.name);
                        userCoordinates = null; // Reset coords if place is invalid
                        return;
                    }
                    userCoordinates = {
                        lat: place.geometry.location.lat(),
                        lng: place.geometry.location.lng()
                    };
                    console.log("Place selected:", place.name, userCoordinates);
                    locationInput.value = place.formatted_address || place.name; // Update input field
                });
                console.log("Autocomplete initialized.");
            } catch (error) {
                console.error("Error initializing Autocomplete:", error);
                showError("Failed to initialize location search functionality.");
            }
        }

        function getUserLocation() {
             if (!navigator.geolocation) { showError("Geolocation is not supported by your browser."); return; }
             const btn = useLocationButton; btn.textContent = "Finding..."; btn.disabled = true; hideError();
             navigator.geolocation.getCurrentPosition( (pos) => {
                 userCoordinates = { lat: pos.coords.latitude, lng: pos.coords.longitude };
                 console.log("Geolocation acquired:", userCoordinates);
                 locationInput.value = `Current Location (${userCoordinates.lat.toFixed(4)}, ${userCoordinates.lng.toFixed(4)})`;
                 btn.textContent = "üìç My Location"; btn.disabled = false;
             }, (err) => {
                 console.error("Geolocation error:", err); let msg = "Could not get your location."; switch(err.code){case 1:msg="Location permission denied.";break; case 2:msg="Location position unavailable.";break; case 3:msg="Location request timed out.";break;} showError(msg); userCoordinates = null; locationInput.value = ''; btn.textContent = "üìç My Location"; btn.disabled = false;
             }, { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 });
         }

        function fetchRestaurants() {
            showView(views.loading);
            hideError();
            const locationText = locationInput.value.trim();
            const radius = parseInt(radiusSelect.value);
            const priceLevel = priceLevelSelect.value;
            const keyword = cuisineKeywordInput.value.trim(); // Use this as the keyword

            if (typeof google === 'undefined' || !google.maps?.places) {
                showError("Location services are not ready. Please wait or refresh.");
                showView(views.search);
                return;
            }

            if (userCoordinates) {
                console.log("Searching using coordinates:", userCoordinates);
                performNearbySearch(userCoordinates, radius, keyword, priceLevel); // Pass keyword
            }
            else if (locationText && !locationText.startsWith("Current Location")) {
                console.log("Searching using text address:", locationText);
                const geocoder = new google.maps.Geocoder();
                geocoder.geocode({ address: locationText }, (results, status) => {
                    if (status === 'OK' && results?.[0]?.geometry?.location) {
                        userCoordinates = {
                            lat: results[0].geometry.location.lat(),
                            lng: results[0].geometry.location.lng()
                        };
                        console.log("Geocoded address to:", userCoordinates);
                        performNearbySearch(userCoordinates, radius, keyword, priceLevel); // Pass keyword
                    } else {
                        console.error("Geocoding failed:", status);
                        showError(`Could not find location: "${locationText}". Please try a different address or use "My Location".`);
                        showView(views.search);
                    }
                });
            }
            else {
                showError("Please provide a location (type an address or use 'My Location').");
                showView(views.search);
            }
        }

        function performNearbySearch(coords, radius, keyword, priceLevel) {
            const placesService = new google.maps.places.PlacesService(document.createElement('div'));
            let request = {
                location: new google.maps.LatLng(coords.lat, coords.lng),
                radius: radius,
                type: 'restaurant'
            };
            if (keyword) {
                 request.keyword = keyword;
            }
            if (priceLevel) {
                const price = parseInt(priceLevel);
                request.minPriceLevel = price;
                request.maxPriceLevel = price;
            }

            console.log("Executing Google Places NearbySearch with request:", request);

            placesService.nearbySearch(request, (results, status, pagination) => {
                console.log("Places API Response Status:", status);
                if (status === google.maps.places.PlacesServiceStatus.OK && results?.length > 0) {
                    const operationalRestaurants = results.filter(p => p.business_status === 'OPERATIONAL').slice(0, 20);

                    if (operationalRestaurants.length === 0) {
                        showError(`No currently operational restaurants found matching your criteria${keyword ? ` for "${keyword}"` : ''}. Try different options.`);
                        showView(views.search);
                        return;
                    }
                    console.log("Found", operationalRestaurants.length, "operational restaurants.");
                    processRestaurantResults(operationalRestaurants, keyword); // Pass the original search keyword
                } else if (status === google.maps.places.PlacesServiceStatus.ZERO_RESULTS) {
                    showError(`No restaurants found matching your criteria${keyword ? ` for "${keyword}"` : ''}. Try widening the distance or changing criteria.`);
                    showView(views.search);
                } else {
                    console.error("Places API Error:", status);
                    showError(`Could not retrieve restaurant data. (Error: ${status})`);
                    showView(views.search);
                }
            });
        }

        function getPlaceDetails(placeIds) {
            const placesService = new google.maps.places.PlacesService(document.createElement('div'));
            const detailFields = ['photos', 'name', 'place_id'];

            const promises = placeIds.map(id => new Promise((resolve) => {
                placesService.getDetails({ placeId: id, fields: detailFields }, (details, status) => {
                    resolve({
                        placeId: id,
                        photos: (status === google.maps.places.PlacesServiceStatus.OK && details?.photos) ? details.photos : []
                    });
                });
            }));

            return Promise.all(promises);
        }

        async function processRestaurantResults(results, searchKeyword) {
             try {
                 const placeIds = results.map(r => r.place_id);
                 console.log("Fetching details for Place IDs:", placeIds);
                 const detailsList = await getPlaceDetails(placeIds);

                 const photoDetailsMap = detailsList.reduce((map, detail) => {
                     map[detail.placeId] = detail.photos;
                     return map;
                 }, {});

                 restaurants = results.map(place => {
                     const placePhotos = photoDetailsMap[place.place_id] || place.photos || [];
                     const photoUrls = placePhotos.slice(0, 5)
                         .map(p => p.getUrl ? p.getUrl({ maxWidth: 600 }) : null)
                         .filter(url => url);

                     if (photoUrls.length === 0) {
                         photoUrls.push("https://placehold.co/600x400/FF5864/white?text=No+Image");
                     }

                     let displayCuisine = "Food";
                     if (searchKeyword) {
                         displayCuisine = searchKeyword.trim().toLowerCase().replace(/\b\w/g, l => l.toUpperCase());
                     } else {
                         displayCuisine = getCuisineFromTypes(place.types || []);
                     }

                     return {
                         id: place.place_id,
                         name: place.name || "Unnamed Restaurant",
                         address: place.vicinity || "Address unavailable",
                         cuisine: displayCuisine,
                         rating: place.rating ? `${place.rating} ‚òÖ (${place.user_ratings_total || 0} reviews)` : "Not rated",
                         priceLevel: place.price_level ?? 0,
                         photoUrls: photoUrls,
                         currentPhotoIndex: 0
                     };
                 });

                 if (restaurants.length === 0) {
                     showError('No valid restaurant data could be processed.');
                     showView(views.search);
                     return;
                 }

                 console.log("Processed restaurants:", restaurants);

                 sessionId = generateSessionId();
                 saveSessionToFirebase();
                 currentIndex = 0;
                 likedRestaurants = {};
                 updateRestaurantDisplay();
                 showView(views.swipe);

             } catch (error) {
                 console.error("Error processing restaurant results:", error);
                 showError("An error occurred while loading restaurant details.");
                 showView(views.search);
             }
         }


         function getCuisineFromTypes(types) {
            const typeMap = { 'cafe': 'Cafe', 'bar': 'Bar', 'bakery': 'Bakery' };
            const knownCuisines = ["Italian", "Chinese", "Japanese", "Mexican", "Indian", "Thai", "American", "French", "Vietnamese", "Korean", "Mediterranean", "Pizza", "Sushi", "Seafood", "Steakhouse"];

            for (const type of types) {
                const formattedType = type.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                if (knownCuisines.includes(formattedType)) {
                    return formattedType;
                }
                if (typeMap[type]) {
                    return typeMap[type];
                }
            }
            return types.includes('restaurant') ? 'Restaurant' : 'Food';
        }


        function createGoogleMapsLink(restaurant) {
            if (!restaurant) return null;
            let url;
            if (restaurant.id) {
                url = `https://www.google.com/maps/search/?api=1&query=Google&query_place_id=${restaurant.id}`;
            } else if (restaurant.name && restaurant.address) {
                const query = encodeURIComponent(`${restaurant.name}, ${restaurant.address}`);
                url = `https://www.google.com/maps/search/?api=1&query=${query}`;
            } else {
                return null;
            }

            const link = document.createElement('a');
            link.href = url;
            link.textContent = "View on Google Maps ‚Üó";
            link.className = "google-maps-link";
            link.target = "_blank";
            link.rel = "noopener noreferrer";
            return link;
        }


        // --- Swipe UI Functions ---
        function updateRestaurantDisplay() {
            if (currentIndex >= restaurants.length) {
                showResultsView();
                return;
            }

            const restaurant = restaurants[currentIndex];
            swipeUI.currentIndex.textContent = currentIndex + 1;
            swipeUI.totalRestaurants.textContent = restaurants.length;

            restaurant.currentPhotoIndex = restaurant.currentPhotoIndex || 0;
            swipeUI.image.src = restaurant.photoUrls[restaurant.currentPhotoIndex];
            swipeUI.image.alt = restaurant.name;

            swipeUI.photoIndicators.innerHTML = '';
            restaurant.photoUrls.forEach((_, index) => {
                const dot = document.createElement('span');
                dot.className = 'photo-dot' + (index === restaurant.currentPhotoIndex ? ' active' : '');
                swipeUI.photoIndicators.appendChild(dot);
            });

            const showNav = restaurant.photoUrls.length > 1;
            swipeUI.prevPhotoBtn.style.display = showNav ? 'flex' : 'none';
            swipeUI.nextPhotoBtn.style.display = showNav ? 'flex' : 'none';
            swipeUI.photoIndicators.style.display = showNav ? 'flex' : 'none';


            swipeUI.name.textContent = restaurant.name;
            swipeUI.cuisine.textContent = `Cuisine: ${restaurant.cuisine}`;
            swipeUI.rating.textContent = `Rating: ${restaurant.rating}`;
            swipeUI.price.textContent = `Price: ${restaurant.priceLevel > 0 ? '$'.repeat(restaurant.priceLevel) : 'N/A'}`;
            swipeUI.address.textContent = `Address: ${restaurant.address}`;

            swipeUI.mapsLinkPlaceholder.innerHTML = '';
            const mapsLink = createGoogleMapsLink(restaurant);
            if (mapsLink) {
                swipeUI.mapsLinkPlaceholder.appendChild(mapsLink);
            }

             const cardContent = views.swipe.querySelector('.card-content');
             if (cardContent) cardContent.scrollTop = 0;
        }

        function changePhoto(direction) {
            if (currentIndex >= restaurants.length) return;
            const restaurant = restaurants[currentIndex];
            const numPhotos = restaurant.photoUrls.length;
            if (numPhotos <= 1) return;

            restaurant.currentPhotoIndex = (restaurant.currentPhotoIndex + direction + numPhotos) % numPhotos;
            updateRestaurantDisplay();
        }


        function handleSwipe(liked) {
            if (currentIndex >= restaurants.length) return;

            const restaurantId = restaurants[currentIndex].id;
            if (liked) {
                likedRestaurants[restaurantId] = true;
                console.log("Liked:", restaurants[currentIndex].name);
            } else {
                console.log("Disliked:", restaurants[currentIndex].name);
            }

            saveLikesToFirebase();

            currentIndex++;

            if (currentIndex < restaurants.length) {
                updateRestaurantDisplay();
            } else {
                showResultsView();
            }
        }


        // --- Results & Matching Functions ---
        function showResultsView() {
            const likedCount = Object.keys(likedRestaurants).length;
            resultsUI.likedCount.textContent = likedCount;
            resultsUI.sessionId.textContent = sessionId;
            resultsUI.friendCodeInput.value = '';
            showView(views.results);
        }

        function findMatches() {
            const friendCode = resultsUI.friendCodeInput.value.trim().toUpperCase();
            if (!friendCode) {
                showError('Please enter your friend\'s code.');
                return;
            }
            if (friendCode === sessionId) {
                showError('You cannot match with your own code!');
                return;
            }

            showView(views.loading);
            hideError();

            if (typeof firebase === 'undefined' || !firebase.apps.length) {
                console.warn("Firebase not initialized. Cannot fetch friend data.");
                showError("Matching service is unavailable. Could not connect.");
                setTimeout(() => {
                    displayMatches([]);
                    showView(views.matches);
                }, 1500);
                return;
            }

            firebase.database().ref('sessions/' + friendCode).once('value')
                .then(snapshot => {
                    const friendData = snapshot.val();

                    if (!friendData) {
                        showError(`Friend code "${friendCode}" not found or expired.`);
                        showView(views.results);
                        return;
                    }

                    const friendLikes = friendData.likes || {};
                    const friendLikedIds = Object.keys(friendLikes);
                    const myLikedIds = Object.keys(likedRestaurants);

                    const matchedIds = myLikedIds.filter(id => friendLikedIds.includes(id));

                    const friendRestaurantsData = friendData.restaurants || [];
                    const friendMap = friendRestaurantsData.reduce((map, r) => { map[r.id] = r; return map; }, {});
                    const myMap = restaurants.reduce((map, r) => { map[r.id] = r; return map; }, {});

                    const matchedRestaurants = matchedIds
                        .map(id => friendMap[id] || myMap[id])
                        .filter(r => r);

                    console.log("Matches found:", matchedRestaurants);
                    displayMatches(matchedRestaurants);

                })
                .catch(error => {
                    console.error("Error fetching friend's data:", error);
                    showError('Could not retrieve friend\'s data. Please check the code and try again.');
                    showView(views.results);
                });
        }

        function displayMatches(matchedRestaurants) {
            matchesUI.list.innerHTML = '';

            if (matchedRestaurants.length > 0) {
                matchedRestaurants.forEach(r => {
                    const item = document.createElement('div');
                    item.className = 'restaurant-item';
                    const priceDisplay = r.priceLevel > 0 ? '$'.repeat(r.priceLevel) : 'N/A';
                    item.innerHTML = `
                        <h3>${r.name}</h3>
                        <p>Cuisine: ${r.cuisine}</p>
                        <p>Rating: ${r.rating}</p>
                        <p class="price-level">Price: ${priceDisplay}</p>
                        <p>Address: ${r.address}</p>
                    `;
                    const mapsLink = createGoogleMapsLink(r);
                    if (mapsLink) {
                        item.appendChild(mapsLink);
                    }
                    matchesUI.list.appendChild(item);
                });
            } else {
                matchesUI.list.innerHTML = '<p style="text-align:center; padding:20px;">No common matches found!</p>';
            }

            showView(views.matches);
        }


        // --- Firebase Integration ---
         function generateSessionId() { return Math.random().toString(36).substring(2, 10).toUpperCase(); }

        function saveSessionToFirebase() {
            if (typeof firebase === 'undefined' || !firebase.apps.length || !sessionId) {
                 console.warn("Firebase not ready or no session ID, skipping session save.");
                 return;
            }
             const restaurantsToSave = restaurants.map(r => ({
                 id: r.id,
                 name: r.name,
                 address: r.address,
                 cuisine: r.cuisine,
                 rating: r.rating,
                 priceLevel: r.priceLevel
             }));

             const sessionData = {
                 restaurants: restaurantsToSave,
                 timestamp: firebase.database.ServerValue.TIMESTAMP,
                 likes: {}
             };

             firebase.database().ref('sessions/' + sessionId).set(sessionData)
                 .then(() => console.log("Session saved to Firebase:", sessionId))
                 .catch(error => console.error("Firebase session save error:", error));
        }

        function saveLikesToFirebase() {
             if (typeof firebase === 'undefined' || !firebase.apps.length || !sessionId) {
                console.warn("Firebase not ready or no session ID, skipping likes save.");
                return;
             }

             firebase.database().ref('sessions/' + sessionId + '/likes').set(likedRestaurants)
                .then(() => console.log("Likes updated in Firebase for session:", sessionId))
                .catch(error => console.error("Firebase likes update error:", error));
        }

        function initializeFirebase() {
            if (typeof firebase === 'undefined' || typeof firebase.initializeApp === 'undefined') {
                console.warn("Firebase SDK not loaded yet.");
                return;
            }
            try {
                // *** UPDATED: Inserted your Firebase Config ***
                 const firebaseConfig = {
                   apiKey: "AIzaSyDauSN6vXVeflYHYdx54hIsXWeTxp-CarM",
                   authDomain: "restaurant-finder-36e61.firebaseapp.com",
                   databaseURL: "https://restaurant-finder-36e61-default-rtdb.asia-southeast1.firebasedatabase.app",
                   projectId: "restaurant-finder-36e61",
                   storageBucket: "restaurant-finder-36e61.appspot.com",
                   messagingSenderId: "266887715200",
                   appId: "1:266887715200:web:6c68d924d7596cdfb44965",
                   measurementId: "G-TD5GNXZZMN"
                 };

                 if (!firebase.apps.length) {
                     firebase.initializeApp(firebaseConfig);
                     console.log("Firebase initialized successfully.");
                 } else {
                    console.log("Firebase already initialized.");
                 }

            } catch (e) {
                 console.error("Firebase initialization error:", e);
                 showError("Sharing features are currently unavailable due to a configuration issue.");
                 resultsUI.findMatchesButton.disabled = true;
                 resultsUI.copyCodeButton.disabled = true;
            }
        }


        // --- Utility & Event Listeners ---
        function resetApp() {
            locationInput.value = '';
            radiusSelect.value = '2000';
            priceLevelSelect.value = '';
            cuisineKeywordInput.value = '';
            resultsUI.friendCodeInput.value = '';

            restaurants = [];
            currentIndex = 0;
            likedRestaurants = {};
            sessionId = '';
            userCoordinates = null;
            hideError();
            showView(views.search);
            console.log("App reset.");
        }

        function copySessionId() {
            const code = resultsUI.sessionId.textContent;
            if (!code || code === 'CODE' || !navigator.clipboard) {
                showError("Cannot copy code. Try selecting manually.");
                return;
            }
            navigator.clipboard.writeText(code).then(() => {
                const originalText = resultsUI.copyCodeButton.textContent;
                resultsUI.copyCodeButton.textContent = '‚úÖ';
                setTimeout(() => {
                    resultsUI.copyCodeButton.textContent = originalText;
                }, 1500);
            }).catch(err => {
                console.error('Failed to copy session code:', err);
                showError("Failed to copy code automatically. Please select and copy manually.");
            });
        }

        window.swipeUI = swipeUI;
        window.resultsUI = resultsUI;
        window.matchesUI = matchesUI;

        // --- Event Listeners ---
        searchForm.addEventListener('submit', (e) => {
            e.preventDefault();
            fetchRestaurants();
        });

        useLocationButton.addEventListener('click', getUserLocation);

        swipeUI.prevPhotoBtn.addEventListener('click', () => changePhoto(-1));
        swipeUI.nextPhotoBtn.addEventListener('click', () => changePhoto(1));
        swipeUI.dislikeButton.addEventListener('click', () => handleSwipe(false));
        swipeUI.likeButton.addEventListener('click', () => handleSwipe(true));

        resultsUI.findMatchesButton.addEventListener('click', findMatches);
        resultsUI.startOverButton.addEventListener('click', resetApp);
        resultsUI.copyCodeButton.addEventListener('click', copySessionId);
        resultsUI.sessionId.addEventListener('click', () => {
             if (resultsUI.sessionId.textContent !== 'CODE') {
                window.getSelection().selectAllChildren(resultsUI.sessionId);
             }
        });


        matchesUI.startOverButton.addEventListener('click', resetApp);

        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            console.log("DOM fully loaded and parsed.");
            showView(views.search);
            loadGoogleMapsScript();
            // Defer Firebase init slightly
            setTimeout(initializeFirebase, 500);
        });

    </script>

    <!-- Firebase SDKs (use compat versions for Realtime Database access pattern used here) -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js" defer></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js" defer></script>

</body>
</html>
